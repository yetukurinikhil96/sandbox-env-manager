# Visual Architecture Guide

## System Overview

```
???????????????????????????????????????????????????????????????????
?                    SANDBOX ENVIRONMENT MANAGER                   ?
???????????????????????????????????????????????????????????????????

????????????????????      ????????????????????      ????????????????????
?   Web UI         ?      ?  Your Frontend   ?      ?  Shell Scripts   ?
?  (index.html)    ?      ?  (React/Vue/etc) ?      ?  (Bash)          ?
????????????????????      ????????????????????      ????????????????????
         ?                         ?                         ?
         ???????????????????????????                         ?
                       ?                                     ?
                   HTTP/JSON                          Direct Execution
                       ?                                     ?
         ?????????????????????????????                       ?
         ?                            ?                       ?
         ?    REST API (Express)      ?????????????????????????
         ?    Port 3000               ?
         ?                            ?
         ??????????????????????????????
                       ?
         ??????????????????????????????
         ?                            ?
         ?  Environment Service       ?
         ?  (Business Logic)          ?
         ?                            ?
         ??????????????????????????????
                       ?
         ??????????????????????????????
         ?                            ?
    ???????????    ??????????????   ?????????????
    ?  Read   ?    ?  Execute   ?   ?   Query   ?
    ? .env-*  ?    ?  Scripts   ?   ?  Azure    ?
    ?  .json  ?    ?  (bash)    ?   ?   CLI     ?
    ???????????    ??????????????   ?????????????
         ?               ?            ?
         ??????????????????????????????
                       ?
         ??????????????????????????????
         ?                            ?
         ?     Azure Resources        ?
         ?  - Resource Groups         ?
         ?  - AKS Clusters            ?
         ?  - Container Registries    ?
         ?  - Kubernetes Namespaces   ?
         ?                            ?
         ??????????????????????????????
```

## Request Flow Example

### 1. List Environments

```
User Browser
    ?
    ? GET http://localhost:3000/api/envs
    ?
Express Server (server.js)
    ?
    ? Route to environments.js
    ?
Route Handler (routes/environments.js)
    ?
    ? Call listEnvironments()
    ?
Environment Service (services/environmentService.js)
    ?
    ??? Scan for .env-*.json files
    ?   ?
    ?   ??? .env-env1.json
    ?   ??? .env-env2.json
    ?   ??? .env-env3.json
    ?
    ??? For each environment:
    ?   ?
    ?   ??? Query Azure CLI
    ?       az group show --name rg-sandbox-env1
    ?       ?
    ?       ??? Get status (Running/Stopped/Starting)
    ?
    ??? Return array of environments
        ?
        ?
JSON Response
[
  { "name": "env1", "status": "Running", ... },
  { "name": "env2", "status": "Starting", ... },
  { "name": "env3", "status": "Running", ... }
]
    ?
    ?
Browser UI
    ?
    ??? Render environment cards
```

### 2. Create Environment

```
User Browser
    ?
    ? POST /api/envs
    ? Body: { "name": "env4", "region": "eastus" }
    ?
Express Server
    ?
    ?
Route Handler
    ?
    ?
Environment Service
    ?
    ? Build command
    ? bash scripts/create_env.sh --name env4 --region eastus
    ?
Execute Script
    ?
    ??? Create Resource Group (rg-sandbox-env4)
    ?   az group create
    ?
    ??? Create Container Registry (acrsandboxenv4)
    ?   az acr create
    ?
    ??? Create AKS Cluster (aks-sandbox-env4)
    ?   az aks create
    ?
    ??? Get Credentials
    ?   az aks get-credentials
    ?
    ??? Create Namespace (ns-env4)
    ?   kubectl create namespace
    ?
    ??? Save Metadata (.env-env4.json)
        ?
        ?
Return Success
    ?
    ?
JSON Response
{ "success": true, "message": "Environment env4 created" }
    ?
    ?
Browser UI
    ?
    ??? Show success message
```

## Component Interaction Matrix

```
????????????????????????????????????????????????????????????????????
?              ?  Web UI    ?   API      ?  Scripts   ?   Azure    ?
????????????????????????????????????????????????????????????????????
?  Web UI      ?     -      ?   HTTP     ?     -      ?     -      ?
?              ?            ?  (fetch)   ?            ?            ?
????????????????????????????????????????????????????????????????????
?  API         ?  Serves    ?     -      ?   Exec     ?   Query    ?
?              ?  Responses ?            ?   (bash)   ?   (az cli) ?
????????????????????????????????????????????????????????????????????
?  Scripts     ?     -      ?  Called    ?     -      ?   Manage   ?
?              ?            ?   by API   ?            ?  Resources ?
????????????????????????????????????????????????????????????????????
?  Azure       ?     -      ?  Queried   ?  Modified  ?     -      ?
?              ?            ?   for      ?   by       ?            ?
?              ?            ?   status   ?  Scripts   ?            ?
????????????????????????????????????????????????????????????????????
```

## File Organization

```
Project Root
?
??? api/                              # Backend API
?   ?
?   ??? server.js                     # Entry point
?   ?   ??? Loads Express
?   ?   ??? Registers routes
?   ?   ??? Starts server on port 3000
?   ?   ??? Handles errors
?   ?
?   ??? routes/
?   ?   ??? environments.js           # Route handlers
?   ?       ??? GET /api/envs
?   ?       ??? GET /api/envs/:name
?   ?       ??? POST /api/envs
?   ?       ??? DELETE /api/envs/:name
?   ?       ??? GET /api/envs/:name/status
?   ?
?   ??? services/
?       ??? environmentService.js     # Business logic
?           ??? listEnvironments()
?           ??? getEnvironment()
?           ??? createEnvironment()
?           ??? deleteEnvironment()
?           ??? getEnvironmentStatus()
?
??? ui/                               # Frontend UI
?   ??? index.html                    # Single-page dashboard
?       ??? Fetch environments
?       ??? Render cards
?       ??? Handle user actions
?       ??? Auto-refresh
?
??? scripts/                          # Shell scripts
?   ??? create_env.sh                 # Creates Azure resources
?   ??? delete_env.sh                 # Deletes Azure resources
?   ??? list_envs.sh                  # Lists environments
?   ??? check_env.sh                  # Checks status
?   ??? create_multiple_envs.sh       # Batch creation
?
??? .env-*.json                       # Environment metadata
    ??? .env-env1.json                # Env1 details
    ??? .env-env2.json                # Env2 details
    ??? .env-env3.json                # Env3 details
```

## Data Flow

### Environment Metadata

```
create_env.sh execution
    ?
    ?
Create .env-<name>.json
    ?
    ??? Content:
        {
          "environmentName": "env1",
          "resourceGroup": "rg-sandbox-env1",
          "aksCluster": "aks-sandbox-env1",
          "namespace": "ns-env1",
          "containerRegistry": "acrsandboxenv1",
          "region": "eastus",
          "nodeCount": 2,
          "nodeSize": "Standard_D2s_v3",
          "createdAt": "2024-01-15T10:30:00Z",
          "kubeContext": "env1",
          "tags": "environment=env1,..."
        }
    ?
    ?
API reads file
    ?
    ??? Parse JSON
    ??? Query Azure for status
    ??? Return to frontend
    ?
    ?
UI displays
```

## API Endpoint Responsibilities

```
???????????????????????????????????????????????????????????
?  Endpoint          ?  Responsibility                    ?
???????????????????????????????????????????????????????????
?  GET /api/health   ?  • Check if API is running        ?
?                    ?  • Return version info             ?
???????????????????????????????????????????????????????????
?  GET /api/envs     ?  • Scan .env-*.json files         ?
?                    ?  • Query Azure for each status     ?
?                    ?  • Return array of environments    ?
???????????????????????????????????????????????????????????
?  GET /api/envs/    ?  • Read .env-<name>.json          ?
?      :name         ?  • Query Azure for detailed status ?
?                    ?  • Return single environment       ?
???????????????????????????????????????????????????????????
?  POST /api/envs    ?  • Validate input                 ?
?                    ?  • Execute create_env.sh           ?
?                    ?  • Wait for completion             ?
?                    ?  • Return success/failure          ?
???????????????????????????????????????????????????????????
?  DELETE /api/envs/ ?  • Execute delete_env.sh          ?
?         :name      ?  • Clean up metadata file          ?
?                    ?  • Return success                  ?
???????????????????????????????????????????????????????????
?  GET /api/envs/    ?  • Execute check_env.sh           ?
?      :name/status  ?  • Parse output                    ?
?                    ?  • Return detailed status          ?
???????????????????????????????????????????????????????????
```

## Environment Lifecycle

```
????????????
?  Create  ?
? Request  ?
????????????
     ?
     ?
???????????????????
? Execute Script  ?
? create_env.sh   ?
???????????????????
     ?
     ?
???????????????????????????????
?  Azure Resource Creation    ?
?  1. Resource Group          ?
?  2. Container Registry      ?
?  3. AKS Cluster (5-10 min)  ?
?  4. Get Credentials         ?
?  5. Create Namespace        ?
???????????????????????????????
     ?
     ?
???????????????????
? Save Metadata   ?
? .env-X.json     ?
???????????????????
     ?
     ?
???????????????????      ??????????????
?  Environment    ???????? API Lists  ?
?   Running       ?      ? & Shows    ?
???????????????????      ??????????????
     ?
     ? (Usage period)
     ?
     ?
???????????????????
?  Delete         ?
?  Request        ?
???????????????????
     ?
     ?
???????????????????
? Execute Script  ?
? delete_env.sh   ?
???????????????????
     ?
     ?
???????????????????????????????
?  Azure Resource Deletion    ?
?  1. Delete Resource Group   ?
?  2. Remove kubectl context  ?
?  3. Delete metadata file    ?
???????????????????????????????
     ?
     ?
???????????????????
?  Environment    ?
?   Removed       ?
???????????????????
```

## Status Detection Logic

```
?????????????????????
? Get Environment   ?
?     Status        ?
?????????????????????
      ?
      ?
???????????????????????????????
? Check if .env-X.json exists ?
???????????????????????????????
      ?
   Yes?     No
      ?     ??? Return "Not Found"
      ?
???????????????????????????????
? Query Azure Resource Group  ?
? az group show --name RG     ?
???????????????????????????????
      ?
  Exists?    Not Found
      ?     ??? Return "Deleted"
      ?
???????????????????????????????
? Check Resource Group State  ?
???????????????????????????????
      ?
      ??? "Succeeded" ???
      ??? "Creating"  ????? Continue to AKS check
      ??? "Failed"   ????
      ?
      ?
???????????????????????????????
? Query AKS Cluster           ?
? az aks show --name CLUSTER  ?
???????????????????????????????
      ?
  Exists?    Not Found
      ?     ??? Return "Creating"
      ?
???????????????????????????????
? Check AKS Power State       ?
???????????????????????????????
      ?
      ??? "Running"  ?? Return "Running"
      ??? "Stopped"  ?? Return "Stopped"
      ??? "Starting" ?? Return "Starting"
```

## Integration Points

```
Your Frontend Application
    ?
    ??? Option 1: Use Web UI
    ?   ??? Open ui/index.html
    ?
    ??? Option 2: Direct API calls
    ?   ??? fetch('http://localhost:3000/api/envs')
    ?
    ??? Option 3: Custom UI + API
    ?   ??? Build your own UI, use API endpoints
    ?
    ??? Option 4: Scripts only
        ??? ./scripts/create_env.sh --name env1
```

## Deployment Architecture

```
Development (Local)
????????????????????????????????
?  Your Machine                ?
?  ??????????????????????????  ?
?  ?  Node.js API           ?  ?
?  ?  Port 3000             ?  ?
?  ??????????????????????????  ?
?  ??????????????????????????  ?
?  ?  Web UI                ?  ?
?  ?  (index.html)          ?  ?
?  ??????????????????????????  ?
????????????????????????????????
         ?
         ? Azure CLI
         ?
????????????????????????????????
?  Azure Cloud                 ?
?  ??????????????????????????  ?
?  ?  Sandbox Environments  ?  ?
?  ?  - env1, env2, env3... ?  ?
?  ??????????????????????????  ?
????????????????????????????????

Production (Deployed)
????????????????????????????????
?  Azure Container Apps        ?
?  ??????????????????????????  ?
?  ?  API Container         ?  ?
?  ?  (Docker)              ?  ?
?  ??????????????????????????  ?
?           ?                  ?
?  ????????????????????????   ?
?  ?  Static Web App      ?   ?
?  ?  (Web UI)            ?   ?
?  ????????????????????????   ?
????????????????????????????????
         ?
         ? Azure Resource Manager API
         ?
????????????????????????????????
?  Azure Cloud                 ?
?  ??????????????????????????  ?
?  ?  Sandbox Environments  ?  ?
?  ?  - env1, env2, env3... ?  ?
?  ??????????????????????????  ?
????????????????????????????????
```

This visual guide shows how all components work together!
